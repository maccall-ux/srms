{% extends "srms/admin_base.html" %} {% load static %} {% block content %}

<div class="container">
  <h2 class="mb-4"><i class="fas fa-plus-circle"></i> Declare Results</h2>

  {% if messages %}

    {% for message in messages %}
        <div class='alert alert-{% if message.tags == 'error' %}danger{% else %}{{message.tags}}{% endif %} alert-dismissible fade show role='alert''>
            {{message}}
            <button type="button" class='btn btn-close' data-bs-dismiss='alert'></button>
        </div>
    {% endfor %}

  {% endif %}

  <form action="" method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label for="class_id" class="form-label">Select Class</label>
      <select name="class" id="class_id" class="form-select" required>
        <option value="">--select class--</option>
        {% for class in classes %}
            <option value="{{class.id}}">{{class.class_name}} - section {{class.section}}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="student_id" class="form-label">Select student</label>
      <select name="student_id" id="student_id" class="form-select" required>
        <option value="">--select student--</option>
        
      </select>
    </div>
    
    <div id='subject_fields'>

    </div>


    <button type="submit" class='btn btn-success'><i class='fas fa-check-circle me-1'></i> Submit</button>

  </form>
</div>
<script>
    document.getElementById('class_id').addEventListener('change',function(){
        const classId = this.value;

        if(!classId) return;

        fetch(`/get_students_subjects/?class_id=${classId}`)
        .then(res=>res.json())
        .then(data=>{
            const studentSelect= document.getElementById('student_id');
            studentSelect.innerHTML='<option value="">--select student--</option>';

            data.students.forEach(stu=>{
                const opt = document.createElement('option');
                opt.value = stu.id;
                opt.text = `${stu.name} (Reg No : ${stu.reg_no})`;
                studentSelect.appendChild(opt);
            });

            const subjectFields = document.getElementById('subject_fields');
            subjectFields.innerHTML="<h5 class='mt-5'>Subject and Marks</h5>";

            data.subjects.forEach(sub=>{
                const div = document.createElement('div');
                div.className='mb-3';
                div.innerHTML=`<label class='form-label'>${sub.name}</lable>
                  <input type='number' name='marks_${sub.id}' class='form-control' required/>`;
                subjectFields.appendChild(div);
            });
        });
    });
</script>
{% endblock content %}
